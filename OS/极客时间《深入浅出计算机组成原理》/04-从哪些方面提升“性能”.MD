# 穿越功耗墙，我们该从哪些方面提升“性能”？

从公式

```
程序的 CPU 执行时间 = 指令数×CPI×Clock Cycle Time
```

可以看出，我们可以从以下三个方面着手提升 CPU 性能：

- 指令数
- CPI
- CPU 主频

从指令数和 CPI 下手提升 CPU 性能相对困难，所以刚开始，研发 CPU 的硬件工程师们选择通过提升 CPU 主频来提升 CPU 性能，在 CPU 上多放一点晶体管，不断提升 CPU 的时钟频率，这样就能让 CPU 变得更快，程序的执行时间就会缩短。

## 功耗：CPU 的极限

CPU，一般都被叫作超大规模集成电路（Very-Large-Scale Integration，VLSI）。这些电路，实际上都是一个个晶体管组合而成的。CPU 在计算，其实就是让晶体管里面的“开关”不断地去“打开”和“关闭”，来组合完成各种运算和功能。

想要计算得快

- 一方面，我们要在 CPU 里，同样的面积里面，多放一些晶体管，也就是增加密度；
- 另一方面，我们要让晶体管“打开”和“关闭”得更快一点，也就是提升主频。

而这两者，都会增加功耗，带来耗电和散热的问题。虽然能在 CPU 上抹硅脂、装风扇，乃至用上水冷或者其他更好的散热设备，但是散热始终有一个极限。CPU 温度过高就会导致 CPU 崩溃，因此，在 CPU 里面，能够放下的晶体管数量和晶体管的“开关”频率也都是有限的。一个 CPU 的功率，可以用这样一个公式来表示：

```
功耗 ~= 1/2 ×负载电容×电压的平方×开关频率×晶体管数量
```

功耗增加太多，就会导致 CPU 散热跟不上，这时，我们就需要降低电压。

## 并行优化，理解阿姆达尔定律

从奔腾 4 开始，Intel 意识到通过提升主频比较“难”去实现性能提升，边开始推出 Core Duo 这样的多核 CPU，通过提升“吞吐率”而不是“响应时间”，来达到目的。即通过并行提高性能。

并不是所有问题，都可以通过并行提高性能来解决。如果想要使用这种思想，需要满足这样几个条件。

- 需要进行的计算，本身可以分解成几个可以并行的任务。
- 需要能够分解好问题，并确保几个人的结果能够汇总到一起。
- 在“汇总”这个阶段，是没有办法并行进行的，还是得顺序执行，一步一步来。

根据这些条件，就引出了常常用到的一个经验定律——阿姆达尔定律：对于一个程序进行优化之后，处理器并行运算之后效率提升的情况。具体可以用这样一个公式来表示：

```
优化后的执行时间 = 受优化影响的执行时间 / 加速倍数 + 不受影响的执行时间
```

## 其他方式

无论是简单地通过提升主频，还是增加更多的 CPU 核心数量，通过并行来提升性能，都会遇到相应的瓶颈。仅仅简单地通过“堆硬件”的方式，在今天已经不能很好地满足我们对于程序性能的期望了。于是，工程师们需要从其他方面开始下功夫了。

- 加速大概率事件
- 通过流水线提高性能
- 通过预测提高性能：分支和冒险”、“局部性原理”

## 学习资料

- 计算机组成与设计：软 / 硬件接口》（第 5 版）的 1.7 和 1.10 节，简单介绍了功耗墙和阿姆达尔定律。
- 《深入理解计算机系统》（第 3 版）的 1.9 节深入讲解了阿姆达尔定律。

## 思考

除了在硬件和指令集的设计层面之外，你在软件开发层面，有用到过类似的思路来解决性能问题吗？

- 算法优化
- 指令数优化
- 锁优化
- 内存优化
