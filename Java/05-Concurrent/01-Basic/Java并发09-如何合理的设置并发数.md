# 如何合理的设置线程池并发数

---
## 1 什么是资源限制

**资源限制**是指：在进行并发编程时，程序的执行速度受限于计算机硬件资源或软件资源

>比如服务器带宽只有2Mb/s,某个资源的下载速度是1Mb/s,系统启动10个线程下载资源，下载速度不会变成10Mb/s.

**硬件资源限制有：**

- 带宽的上传和下载速度
- 硬盘读写速度，IO瓶颈
- cpu处理速度，CPU计算瓶颈

**软件资源限制有：**

- 数据库的连接数
- socket的连接数

### 资源限制引发的问题

并发编程中，将代码的执行速度加快的原则是将代码中串行执行部分变成并行的，但是如果将某段串行执行的代码变成并行之后，因为资源的限制，仍然在串行执行，那么这个时候程序的执行速度并没有加快执行，反而更慢。因为增加了上下文切换和资源调度的时间。

---
## 2 任务分类

- IO密集型：文件、网络
- CPU密集型：复杂计算，查询
- 混合型任务

### IO密集型

可以使用稍大的线程池，一般为**2 * CPU核心数+1**。IO密集型任务CPU使用率并不高(IO调度并不占用CPU，而是交给DMA芯片)，因此可以让CPU在等待IO的时候去处理别的任务，充分利用CPU时间。

### CPU密集型

尽量使用较小的线程池，一般为**CPU核心数+1**。因为CPU密集型任务使得CPU使用率很高，若开过多的线程数，只能增加上下文切换的次数，因此会带来额外的开销。

>《Java并发编程实战》：对于计算密集型的任务，在拥有N个处理器的系统上，当线程池的大小为N+1时，通常能实现最优的效率。(即使当计算密集型的线程偶尔由于缺失故障或者其他原因而暂停时，这个额外的线程也能确保CPU的时钟周期不会被浪费。)

### 混合型

可以将任务分成IO密集型和CPU密集型任务，然后分别用不同的线程池去处理。 只要分完之后两个任务的执行时间相差不大，那么就会比串行执行来的高效。 因为如果划分之后两个任务执行时间相差甚远，那么先执行完的任务就要等后执行完的任务，最终的时间仍然取决于后执行完的任务，而且还要加上任务拆分与合并的开销，得不偿失。

并发高、业务执行时间长的情况，解决这种任务的关键不在于线程池，而在于**整体架构的设计**，比如缓存，增加服务器等。

---
## 3 线程池

线程池的设计是针对具体的任务类型的，比如IO密集型、CPU密集型任务，可以同时存在多个线程池，不同线程池执行不同的任务，当没有任务执行的时候，线程池中的线程会在规定时间后自动销毁或者阻塞，不会造成过多的资源消耗。

----
## 4 提交10000个任务

什么样的场景需要一次性提交10000个任务，在客户端层面一般不存在这样的场景，其次一次性提交一万个任务到内存中并不可靠，万一程序中途退出岂不是未完成的任务都丢失了，所以提交的任务应该直接进行持久化。

---
## 引用

- [java线程池大小为何会大多被设置成CPU核心数+1？](https://www.zhihu.com/question/38128980)
- [如何实现单服务器300万个长连接的？](https://www.zhihu.com/question/20831000)
- [线程数究竟设多少合理](https://www.jianshu.com/p/ad7a889598e5)
- [操作系统多进程多线程的相关问题？](https://www.zhihu.com/question/48500642)
- [I/O会一直占用CPU吗](https://www.zhihu.com/question/27734728)
