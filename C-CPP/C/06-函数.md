# 函数

函数是用于完成特定任务的程序代码自包含单元。

---
## 1 函数语法

```c
[数据类型说明] 函数名 ([参数]){
    执行代码块
    return (表达式);
}
```

1. `[]`包含的内容可以省略，数据类型说明省略，则默认是 int 类型函数；参数省略表示该函数是无参函数，参数不省略表示该函数是有参函数；
2. 函数名称遵循标识符命名规范；
3. 自定义函数尽量放在 main 函数之前，如果要放在 main 函数后面的话，需要在 main 函数之前先声明自定义函数，声明格式为：`extern [数据类型说明] 函数名称（[参数]）;`，但是声明对于函数来说，默认为extern，所以一般不需要加 extern。这个规则对其他函数间的调用也适用。
4. 函数调用的基本格式：**`函数名([参数]);`**
5. 在函数中不需要函数参数的称之为**无参函数**，在函数中需要函数参数的称之为**有参函数**
6. 形参与实参，实参就是实际传入函数的参数，`实参可以是常量、变量、表达式、函数等`；形参是方法声明的参数，`形参只有在被调用时才分配内存单元`
7. 函数使用 return 返回函数运行的结果`return 表达式 或者为：return (表达式);`
8. 函数可以递归调用，**递归就是一个函数在它的函数体内调用它自身**，注意递归的层次不能太深。

---
## 2 函数声明顺序与函数声明、函数定义、函数原型（Prototype）

```c
#include <stdio.h>

void newline(void){
    printf("\n");
}

void threeline(void){
    newline();
    newline();
    newline();
}

int main(void){
    printf("Three lines:\n");
    threeline();
    printf("Another three lines.\n");
    threeline();
    return 0;
}
```

`void threeline(void)`这一行，声明了一个函数的名字、参数类型和个数、返回值类型，这称为函数原型。在代码中可以单独写一个函数原型，后面加`;`号结束，而不写函数体：

```c
void threeline(void);
```

这种写法只能叫函数声明而不能叫函数定义，只有带函数体的声明才叫定义。只有分配存储空间的变量声明才叫变量定义，其实函数也是一样，编译器只有见到函数定义才会生成指令，而指令在程序运行时当然也要占存储空间。**那么没有函数体的函数声明有什么用呢？** 它为编译器提供了有用的信息，编译器在翻译代码的过程中，只有见到函数原型（不管带不带函数体）之后才知道这个函数的名字、参数类型和返回值，这样碰到函数调用时才知道怎么生成相应的指令，所以函数原型必须出现在函数调用之前，这也是遵循“**先声明后使用**”的原则。

main 调用 threeline，threeline 再调用 newline，要保证每个函数的原型出现在调用之前，就只能按先 newline 再 threeline 再 main 的顺序定义了。如果使用不带函数体的声明，则可以改变函数的定义顺序：

```c
#include <stdio.h>

void newline(void);
void threeline(void);

int main(void){
    printf("Three lines:\n");
    threeline();
    printf("Another three lines.\n");
    threeline();
    return 0;
}

void newline(void){
    printf("\n");
}

void threeline(void){
    newline();
    newline();
    newline();
}
```

### Old Style C

由于有Old Style C语法的存在，并非所有函数声明都包含完整的函数原型，例如voidthreeline();这个声明并没有明确指出参数类型和个数，所以不算函数原型，这个声明提供给编译器的信息只有函数名和返回值类型。如果在这样的声明之后调用函数，编译器不知道参数的类型和个数，就不会做语法检查，所以很容易引入Bug。

### 隐式声明（Implicit Declaration）

如果在调用函数之前没有声明会怎么样呢？

```c
#include <stdio.h>

int main(void){
    printf("Three lines:\n");
    threeline();
    printf("Another three lines.\n");
    threeline();
    return 0;
}

void newline(void){
    printf("\n");
}

void threeline(void){
    newline();
    newline();
    newline();
}
```

编译时会报警告：

```shell
warning: conflicting types for ‘threeline’main.c
warning: previous implicit declaration of ‘threeline’ was here
```

上面能编译通过，运行结果也对。这里涉及到的规则称为函数的隐式声明（ImplicitDeclaration），在main函数中调用threeline时并没有声明它，编译器认为此处隐式声明了intthreeline(void);，隐式声明的函数返回值类型都是int，由于我们调用这个函数时没有传任何参数，所以编译器认为这个隐式声明的参数类型是void，这样函数的参数和返回值类型都确定下来了，编译器根据这些信息为函数调用生成相应的指令。然后编译器接着往下看，看到threeline函数的原型是void threeline(void)，和先前的隐式声明的返回值类型不符，所以报警告。好在我们也没用到这个函数的返回值，所以执行结果仍然正确。

### 为什么编译器在处理函数调用代码时需要有函数原型

因为必须知道参数的类型和个数以及返回值的类型才知道生成什么样的指令。为什么隐式声明靠不住呢？因为隐式声明是从函数调用代码推导而来的，而事实上函数定义的形参类型可能跟函数调用代码传的实参类型并不一致，如果函数定义带有可变参数（例如 printf），那么从函数调用代码也看不出来这个函数带有可变参数，另外，从函数调用代码也看不出来返回值应该是什么类型，所以隐式声明只能规定返回值都是int型的。既然隐式声明靠不住，那编译器为什么不自己去找函数定义，而非要让我们在调用之前写函数原型呢？因为编译器往往不知道去哪里找函数定义。

---
## 3 内部函数与外部函数

- 使用`static`修饰的函数成为内部函数，只能在同一个源文件内被调用，多个源文件取相同的内部函数名是允许的，格式为`static [数据类型] 函数名（[参数]）`
- 不使用`static`修饰的函数就是外部函数，可以被其他源文件调用，格式为`extern [数据类型] 函数名([参数])`，C语言规定，在没有指定函数的作用范围时，系统会默认认为是外部函数，因此当需要定义外部函数时extern也可以省略。同时不建议使用extern来定义函数的。extern应该只用于声明

---
## 4 内联函数

C99新增的内联函数：内联函数是指用 `inline` 关键字修饰的函数。在类内定义的函数被默认成内联函数。内联函数从源代码层看，有函数的结构，而在编译后，却不具备函数的性质。内联扩展是用来消除函数调用时的时间开销。它通常用于频繁执行的函数，对于小内存空间的函数非常受益。

内联函数注意：

- 递归函数不能定义为内联函数
- 内联函数一般适合于不存在while和switch等复杂的结构且只有1~5条语句的小函数上，否则编译系统将该函数视为普通函数。
- 内联函数只能先定义后使用，否则编译系统也会把它认为是普通函数。
- 对内联函数不能进行异常的接口声明。