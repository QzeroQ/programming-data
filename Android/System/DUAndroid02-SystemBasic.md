# 操作系统基础

---
## 1 计算机体系结构

硬件是软件的基石，所有的软件功能最终都由硬件来实现。计算机体系结构是一门科学，是软件和硬件的抽象。

### 冯诺依曼结构

冯诺依曼结构又被称为冯诺依曼模型或普林斯顿结构，起源于1945年。两个重要的观点：
- 采用二进制，抛弃十进制，简化计算机设备的逻辑线路
- 程序存储，建议计算机能够实现程序存储和程序控制，具体而言就是程序指令和数据都存储在同一内存存储器中。因为它们的宽度是一样，不过程序指令和数据共享同一总线也在一定程度上成了冯诺依曼机器的瓶颈。

### 哈佛结构

哈飞结构和冯诺依曼结构都属于stored-program体系，区别在于前者的指令和数据并不保存在同一个存储器中，哈佛结构是对冯诺依曼结构的改进与完善。这意味着：

- 指令与数据可以有不同的数据宽度
- 执行速度更快

### 共同点

不论何种结构，它们所包含的基本元素是不变的：

- CPU
- 内存储器
- 输入设备
- 输出设备

输入设备和输出设备也统称为I/O设备。

---
## 2 什么是操作系统

操作系统是负责管理系统硬件，并为上层应用提供稳定的编程接口和人机交互的软件集合。

- 向下管理硬件
- 向上提供编程接口

---
## 3 进程间通讯的经典实现

Inter-process communication(IPC)是指运行在不同进程(不论是否在同一台机器)中的若干线程的数据交互。

- 文件共享：需要处理同步问题
- 共享内存：linux在sys/ipc.h等头文件中提供了相关编程接口
- 管道：管道是操作系统常见的一种IPC机制，适用于所有POSIX系统以及Windows系统，Pip形象的描述了通讯双方的行为，即进程A与进程B
    - 分立管道两边进行数据传输
    - 管道是单向的，意味着如果一个进程既要读取也要写入的话，那么需要建立两个管道
    - 一个管道同时具有读取端和写入端，比如A在读取端，则B在写入端
    - 管道有容量限制，当Pipe写满时，写操作会阻塞，反之读操作也会阻塞
- UNIX Domain Socket：专门针对单机内进程间通信提出来的，有时也被称为IPC Socket，Android中用到最大的IPC机制时Binder，其次时UDS
- RPC：Remote Procedure Calls

---
## 4 同步机制的经典实现

如果多个进程间存在时序关系，需要协同工作已完成一项任务，则成为同步。如果它们并不满足协同条件，而只是因为共享具有排他性的资源时所产生的关系则称为互斥。

- 信号量(Semaphore)
- Metux互斥体
- 管程(Monitor)
- Linux Futex

---
## 5 Android中的同步机制

- Metux：`frameworks/native/include/utils/Metux.h`
- Condition：`frameworks/native/include/utils/Condition.h`
- Barrier：`frameworks/native/include/utils/Barrier.h`，Barrier是基于Metux和Condition实现的一个模型

---
## 6 操作系统内存管理基础

内存管理(Memory Management)旨在为系统中的所有的Task提供稳定可靠的内存分配、释放、与保护机制。

内存管理需要理解的几个核心：
- 虚拟内存：目的是加大物理内存以保证各类大内存占用软件的运行，将外部存储器的部分空间作为内存扩展。当内存资源不足时，系统将按照一定算法自动挑选优先级低的数据块，将它们存储到磁盘中，后续如果需要则这些数据块，系统将产生**缺页**指令，将它们交换回内存中，这些都由操作系统自动完成，对上层应用时透明的。理解虚拟内存，需要学习3种不同的地址空间。
    - 逻辑地址：也叫相对地址，是程序编译后所产生的地址
    - 线性地址，是逻辑地址经过分段机制转换后形成的
    - 物理地址：机器真实的物理内存所有表示的地址空间范围，任何机器最终都需要经过真实的物理地址来访问内存
    - 转换过程：`逻辑地址-->线性地址-->物理地址`
- 内存分配与回收
    - 保证硬件无关性
    - 动态分配内存和回收
    - 内存碎片，比如Android中的内存碎片分为Native成和Java层。
- 内存保护：任何进程都没有办法访问到它管辖范围之外的内存空间，即使刻意产生的内存越界与非法访问，操作系统也会马上阻止并强行关闭程序，从而有力的保障应用程序和操作系统的安全和稳定

进行间通讯：mmap函数

写时拷贝技术：Copy on write，多个对象起始时共享某些资源，直到某个对象需要修改资源时才拥有自己的一份拷贝。

---
## 7 Android中的Low Memory Killer

Linux系统的内存监控机制，OOMKiller，一旦发现系统可用内存达到临界值，就按照优先级顺序，从低到高杀掉进程，回收内存。参考因素是：

- 进程消耗时间
- 进程占用CPU时间
- oom_adj（OOM权重）

Android基于Linux内核的OOMKiller核心思想，扩展处理自己的内存监控体系：Low Memory Killer

---
## 8 Android匿名共享内存(Anonymous Shared Memory)

Anonymous Shared Memory(Ashmem)是Android特有的内存共享机制，可以将直到的物理内存分别映射到各个进程自己的虚拟地址空间，从而便捷地实现进程间的内存共享。

- Ashmem设备：`/dev/ashmem`

---
## 9 JNI

通常下面3种情况下需要用到JNI：

- 程序需要一些平台相关的feature支持，而java无法满足
- 兼容以前的用其他语言实现的代码库
- 应用程序的某些关键操作要求较高的运行速度

JNIEnv实质上是指向一个函数列表的指针。

---
## 10 学习Android的两条线索

- 主线：操作系统的体系结构、硬件组成
- 辅线：在主线的基础上，以Android的5层框架为辅，逐一解析各层框架种的重要元素。

