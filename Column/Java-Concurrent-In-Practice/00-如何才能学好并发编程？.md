# 如何才能学好并发编程？

并发编程并不是一门相对独立的学科，而是一个综合学科。

---
## 1 跳出来，看全景

从一个个单一的知识和技术中“跳出来”，高屋建瓴地看并发编程。**首要之事就是建立起一张知识全景图**。

全景图：并发编程领域可以抽象成三个核心问题：**分工、同步和互斥。**

### 分工

所谓分工，类似于现实中一个组织完成一个项目，项目经理要拆分任务，安排合适的成员去完成。

- Java SDK 并发包里的 Executor、Fork/Join、Future 本质上都是一种分工方法。
- 并发编程领域还总结了一些设计模式，基本上都是和分工方法相关的：`生产者 - 消费者`、`Thread-Per-Message`、`Worker Thread 模式` 等都是用来指导开发者如何分工的。

学习这部分内容，最佳的方式就是和现实世界做对比。

### 同步

分好工之后，就是具体执行了。在项目执行过程中，任务之间是有依赖的，一个任务结束后，依赖它的后续任务就可以开工了，后续工作怎么知道可以开工了呢？这个就是靠沟通协作了，这是一项很重要的工作。**在并发编程领域里的同步，主要指的就是线程间的协作，本质上和现实生活中的协作没区别，不过是一个线程执行完了一个任务，如何通知执行后续任务的线程开工而已**。

协作一般是和分工相关的。

- Java SDK 并发包里的 `Executor、Fork/Join、Future` 本质上都是分工方法，但同时也能解决线程协作的问题。例如，用 Future 可以发起一个异步调用，当主线程通过 get() 方法取结果时，主线程就会等待，当异步执行的结果返回时，`get()` 方法就自动返回了。主线程和异步线程之间的协作，Future 工具类已经帮我们解决了。
- Java SDK 里提供的 CountDownLatch、CyclicBarrier、Phaser、Exchanger 也都是用来解决线程协作问题的。

也还有很多场景，需要我们自己来处理线程之间的协作，但线程协作问题，基本上都可以描述为这样的一个问题：**当某个条件不满足时，线程需要等待，当某个条件满足时，线程需要被唤醒执行**。例如生产者与消费者模型。

**管程**：在 Java 并发编程领域，解决协作问题的核心技术是管程，上面提到的所有线程协作技术底层都是利用管程解决的。管程是一种解决并发问题的通用模型，除了能解决线程协作问题，还能解决线程间的互斥问题。可以这么说，管程是解决并发问题的万能钥匙。

**总结**：并发相关内容的学习：

- 首先：**关键是理解管程模型**，学好它就可以解决所有问题。
- 其次是了解 Java SDK 并发包提供的几个线程协作的工具类的**应用场景**，用好它们可以妥妥地提高你的工作效率。

### 互斥

分工、同步主要强调的是性能，但并发程序里还有一部分是关于正确性的，用专业术语叫 **“线程安全”**，并发程序里，当多个线程同时访问同一个共享变量的时候，结果是不确定的。

这个不确定型的主要源头就是：

- 可见性问题
- 有序性问题
- 原子性问题

如何解决这三个问题，Java 语言引入了内存模型，内存模型提供了一系列的规则，利用这些规则，我们可以避免可见性问题、有序性问题，但是还不足以完全解决线程安全问题。**解决线程安全问题的核心方案还是互斥**。

所谓互斥，指的是同一时刻，只允许一个线程访问共享变量。

- 实现互斥的核心技术就是**锁**，Java 语言里 synchronized、SDK 里的各种 Lock 都能解决互斥问题。
- 锁带来的问题——**性能**

那如何保证安全性的同时又尽量提高性能呢？可以分场景优化：

- Java SDK 里提供的 ReadWriteLock、StampedLock 就可以优化读多写少场景下锁的性能。
- 使用无锁的数据结构，例如 Java SDK 里提供的原子类都是基于无锁技术实现的。
- 只读数据：Thread Local 和 final 关键字
- Copy-on-write 的模式

**死锁**：使用锁除了要注意性能问题外，还需要注意死锁问题。

### 知识全景图

跳出来，看全景，可以让你的知识成体系，所学知识也融汇贯通起来，由点成线。

![](images/00-knowledge_map.png)

---
## 2 钻进去，看本质

不要只去讲述或被讲述一堆概念和结论，而不分析这些概念和结论是怎么来的，以及它们是用来解决什么问题的。

如何看本质：工程上的解决方案，一定要有理论做基础，所以在学习并发编程的过程中，要去探索它背后的理论是什么。比如：

- 当看到 Java SDK 里面的条件变量 Condition 的时候，要去探索`“它是从哪儿来的？是 Java 的特有概念，还是一个通用的编程概念？”`
- 当知道它来自管程的时候，要去探索`“管程被提出的背景和解决的问题是什么？”`

---
## 3 总结：知识要成体系

1. 并发知识没有成体系：试图上来就看 Java SDK 的并发包，可能很快就会放弃。原因是得东西太多，眼花缭乱的，虽然借助网络上的技术文章，感觉都看懂了，但是很快就又忘了。实际应用的时候大脑也一片空白，根本不知道从哪里下手，有时候好不容易解决了个问题，也不知道这个方案是不是合适的。
2. 如何成体系：一定要挖掘 Java SDK 并发包背后的设计理念。Java SDK 并发包是并发大师 Doug Lea 设计的，他一定不是随意设计的，一定是深思熟虑的，其背后是 Doug Lea 对并发问题的深刻认识。

---
## 4 书籍与资料推荐

- 《Java并发编程实战》作者阵容可谓大师云集，也包括Doug Lea
- 《Java并发编程的艺术》讲解并发包内部实现原理，能读明白，内功大增
- 《图解Java多线程设计模式》并发编程设计模式方面的经典书籍
- 《操作系统：精髓与设计原理》经典操作系统教材
- <http://ifeve.com> 国内专业并发编程网站
- <http://www.cs.umd.edu/~pugh/java/memoryModel/>